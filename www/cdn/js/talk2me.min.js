(function(){function U(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})}function t(){var a=new Date;return a.today()+" "+a.timeNow()}function u(){$("html, body").animate({scrollTop:0})}function q(){var a=$("#error");0<a.size()&&a.each(function(a,c){$(c).remove()})}function G(a,b,c){var d="";c&&(d=H()+" ");c="";c="Free"===b?d+"@"+a:d+"@"+a+'.<span class="user-status">'+b+"</span>";0<$(".room-user[data-username='"+a+"']").size()&&
(b='<span class="room-user" data-username="'+a+'">'+c+"</span>",I(a),$("#users-online").prepend(b))}function V(a,b){var c="";b&&(c=H()+" ");1>$(".room-user[data-username='"+a+"']").size()&&(c='<span class="room-user" data-username="'+a+'">'+c+"@"+a+"</span>",$("#users-online").prepend(c))}function I(a,b){var c=$(".room-user[data-username='"+a+"']");0<c.size()&&c.remove()}function W(a){for(var b in a)1>$(".room-user[data-username='"+b+"']").size()&&$("#users-online").append('<span class="room-user" data-username="'+
b+'">'+a[b]+"</span>")}function v(a,b){return!a||b&&a?!0:!1}function X(a){if(l)if(a=JSON.parse(a),"message"===a.a&&"typing"===a.t)v(a.encrypted,d)&&1>$(".from-"+a.from).size()&&$.jGrowl(a.msg,{life:3500,group:"from-"+a.from});else if("message"===a.a&&"status-message"===a.t)v(a.encrypted,d)&&("disconnect"===a.statusType?I(a.username,a.encrypted):"join"===a.statusType?V(a.username,a.encrypted):"statusChange"===a.statusType&&G(a.username,a.currentStatus,a.encrypted),$.jGrowl(a.msg,{life:1500,group:"from-status-"+
a.from}));else if("message"===a.a&&"who"===a.t)W(a.users);else if("message"===a.a&&"message"===a.t){if(a.msg&&(d&&a.encrypted&&(a.msg=w(a.msg)),v(a.encrypted,d))){0<$(".from-"+a.from).size()&&(x=parseInt((new Date).getTime())-2E3,$(".from-"+a.from).remove());var b=new Audio("cdn/sounds/"+notifMessage);b.volume=.5;b.play();r(a.msg,a.encrypted);y||"message"!==a.t||Tinycon.setBubble(++z)}}else"showMoreMessages"===a.a?Y(a):"login"===a.a&&(a.isLoggedIn?(q(),$("#login-form").prepend('<div id="error"></div>'),
$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Username already taken")):(b=$("#message-form").html(),b=Handlebars.compile(b)({room:f,username:e}),$("#login-form").replaceWith(b),k&&($(".messages").before('<div class="more-messages-alert container">Persistent messages enabled</div>'),$.each(a.messages,function(a,b){b.item.encrypted&&(b.item.message=A()+" "+w(b.item.message));
b.item.message&&$(".messages").append('<div class="well well-sm message">'+Wwiki.render(B.link(b.item.message))+"</div>")}),s=b=$(a.messages).size(),0<b&&b===a.moreMessagesLimit&&($(".messages").append('<div class="more-messages"><button type="button" class="btn btn-default" id="show-more-messages">More</button>'),J())),$("#message").focus(),$("#message").keypress(function(a){if(13==a.which)return a.preventDefault(),K(),!1;a=parseInt((new Date).getTime());a-2E3>x&&(g.send(JSON.stringify({a:"typing",
encrypted:d})),x=a)}),$("#send-message").on("click",function(){K()}),L(),Z(),aa(),ba(),$(".btn-tooltip").tooltip()))}function K(){var a=$("#message").val();if(!(void 0===a||1>a.length))if(a.match(/^\s*(\/logout|\/exit|\/quit|\/q)\s*$/))M();else if(a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}!?\s*$/)){var b=a.replace(/\/room\s*([0-9a-zA-Z_\-\.]{1,16})!?\s*/,"$1");a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}!\s*$/)?window.location.hash="#"+b+"@"+e+"!":window.location.hash="#"+b+"@"+e;location.reload()}else if(a.match(/^\s*(\/search|\/find)/))a=
{a:"search",q:a.replace(/^\s*(\/search|\/find)\s*(.*?)\s*$/,"$2"),persistent:k,encrypted:d},g.send(JSON.stringify(a));else if(a.match(/^\s*(\/clear|\/refresh)\s*$/))C();else{b=a='<span class="room-user-message">@'+e+"</span> "+U(a)+' <span class="timestamp">'+t()+"</span>";if(d)try{a=asmCrypto.bytes_to_base64(asmCrypto.AES_CBC.encrypt(asmCrypto.string_to_bytes(a),asmCrypto.PBKDF2_HMAC_SHA256.bytes(h,"talk2me chiquita #94011",4096,16)))}catch(c){console.log("Could not encrypt message."),a=!1}a?(a=
{a:"message",msg:a,persistent:k,encrypted:d},g.send(JSON.stringify(a)),r(b,d)):$.jGrowl("Message not sent - could not encrypt!",{life:8E3,group:"error-encryption"});u()}$("#message").val("");$("#message").focus()}function A(){return'<span class="glyphicon glyphicon-lock btn-tooltip" title="This message is encrypted."></span>'}function H(){return'<span class="glyphicon glyphicon-lock btn-tooltip" title="This users messages are encrypted."></span>'}function r(a,b){b&&(a=A()+" "+a);$(".messages").prepend('<div class="well well-sm message">'+
Wwiki.render(B.link(a))+"</div>")}function D(){f=$("#room").val().trim();e=$("#username").val().trim();if(void 0!==e&&e.match(/^[0-9a-zA-Z_\-\.]{1,16}$/)){l=!0;if(void 0!==f&&1<f.length){if(!f.match(/^[0-9a-zA-Z_\-\.]{1,16}$/))return q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Rooms must be 1-16 of these characters: 0-9a-zA-Z_-."),
!1}else f="public";if($("#usekey").is(":checked")){d=!0;h=$("#secret").val();var a=h.length;if(16>a||32<a)return q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Secret key for client-side encryption must be between 16 and 32 characters."),!1;if(void 0===h||null===h)h="";else{for(var a="",b=0;32>b;b++)a+="p";h+=a.slice(h.toString().length)}}else d=
!1,h="";$("#persistent").is(":checked")?(k=!0,window.location.hash=f+"@"+e+"!"):window.location.hash=f+"@"+e;$(".header").hide();ca(f,e)}else return $(".header").show(),q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Usernames must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}function L(){$("#logout").on("click",
function(){M()})}function M(){d=l=!1;h="";g.send(JSON.stringify({a:"logout",encrypted:d}));window.location.href=window.location.protocol+"//"+window.location.hostname+window.location.pathname}function ba(){$(".chg-status").on("click",function(){var a=$(this).text();E(a);$("#message").focus();u()})}function E(a){G(e,a,d);$("#current-status").text(a);g.send(JSON.stringify({a:"statusChange",status:a,encrypted:d}))}function Z(){$("#who").on("click",function(){N()})}function aa(){$("#clear-messages").on("click",
function(){C()})}function C(){var a=$(".message");0<a.size()&&(a.each(function(a,c){$(c).remove()}),N())}function N(){g.send(JSON.stringify({a:"who",encrypted:d}));$("#message").focus();u()}function O(a,b){try{g.send(JSON.stringify({a:"login",room:a,username:b,persistent:k,encrypted:d}))}catch(c){}}function ca(a,b){n?O(a,b):(g=new WebSocket(webSocketUrl),g.onopen=function(c){p&&C();n=!0;p=!1;O(a,b)},g.onclose=function(a){n=l=!1;$("#message").remove();if(!p){$(".main-control").html('<div id="login-form">\x3c!--add form on reconnect--\x3e</div>');
a=$("#connection-lost-msg").html();a=Handlebars.compile(a);var b={timestamp:t()};a=a(b);r(a);F()}},g.onerror=function(a){n=l=!1;$("#message").remove();if(!p){$(".main-control").html('<div id="login-form">\x3c!--add form on reconnect--\x3e</div>');a=$("#connection-lost-msg").html();a=Handlebars.compile(a);var b={timestamp:t()};a=a(b);r(a);F()}},g.onmessage=function(a){l&&X(a.data)})}function F(){p=!0;n||(1>$("#room").size()&&$("body").append('<input id="room" type="hidden" />'),1>$("#username").size()&&
$("body").append('<input id="username" type="hidden" />'),k&&1>$("#persistent").size()&&$("body").append('<input id="persistent" checked="checked" type="checkbox" value="yes" style="display:none; visibility:hidden;" />'),P(),setTimeout(F,2E3),$(".more-messages").remove(),$(".more-messages-alert").remove(),$(".messages").children().remove())}function Q(){var a=moment().format("X")-R;!m&&a>idleInSeconds&&"Free"===$("#current-status").text()&&(E("Idle"),m=!0);setTimeout(Q,5E3)}function S(){m&&(m=!1,
R=moment().format("X"),E("Free"))}function P(){Q();e=f="";var a=window.location.hash;a.match(/#/)&&a.match(/@/)&&(a.match(/!/)?($("#persistent").prop("checked",!0),f=a.replace(/^#(.*)@.*/,"$1"),$("#room").val(f),e=a.replace(/^#.*@(.*)!$/,"$1")):(k=!1,f=a.replace(/^#(.*)@.*/,"$1"),$("#room").val(f),e=a.replace(/^#.*@(.*)$/,"$1")),$("#username").val(e),D())}function T(a,b,c){0<a.size()&&(a.hasClass(b)&&a.removeClass(b),a.hasClass(c)||a.addClass(c))}function w(a){try{return asmCrypto.bytes_to_string(asmCrypto.AES_CBC.decrypt(asmCrypto.base64_to_bytes(a),
asmCrypto.PBKDF2_HMAC_SHA256.bytes(h,"talk2me chiquita #94011",4096,16)))}catch(b){return console.log("Could not decrypt message."),!1}}function Y(a){if(k){$.each(a.messages,function(a,b){b.item.encrypted&&(b.item.message=A()+" "+w(b.item.message));$(".messages").append('<div class="well well-sm message">'+Wwiki.render(B.link(b.item.message))+"</div>")});var b=$(a.messages).size();s+=b;0<b&&b===a.moreMessagesLimit&&($(".messages").append('<div class="more-messages"><button type="button" class="btn btn-default" id="show-more-messages">More</button>'),
J())}}function J(){$("#show-more-messages").on("click",function(){$(".more-messages").remove();g.send(JSON.stringify({a:"moreMessages",persistent:k,offset:s,encrypted:d}))})}var l=!1,x=parseInt((new Date).getTime())-2E3,d=!1,k=!1,h="",n=!1,p=!1,m=!1,R=moment().format("X"),f="",e="",y=!0,z=0,g=null,s=0,B=new Autolinker({newWindow:!0,stripPrefix:!1,email:!1,twitter:!1,urls:!0});Date.prototype.today=function(){return this.getFullYear()+"-"+(10>this.getMonth()+1?"0":"")+(this.getMonth()+1)+"-"+(10>this.getDate()?
"0":"")+this.getDate()};Date.prototype.timeNow=function(){return(10>this.getHours()?"0":"")+this.getHours()+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+":"+(10>this.getSeconds()?"0":"")+this.getSeconds()};String.prototype.trim=function(){return this.replace(/^\s +|\s +$/g,"")};String.prototype.ltrim=function(){return this.replace(/^\s +/,"")};String.prototype.rtrim=function(){return this.replace(/\s +$/,"")};$(document).ready(function(){P();allowPersistentRooms||$(".persistent-wrapper").remove();
$("pre").livequery(function(){$("pre").each(function(a,b){hljs.highlightBlock(b)})});$(".btn-tooltip").livequery(function(){$(".btn-tooltip").tooltip()});$(".btn-help").livequery(function(){$(".btn-help").popover({html:!0,placement:"auto left"})});$("#room").focus();$("#room, #username").keypress(function(a){if(13==a.which)return a.preventDefault(),D(),!1});$("#login-button").on("click",function(){D();return!1});L();$("#usekey").on("click",function(){$("#usekey").is(":checked")?(T($("#keyform"),"block-hidden",
"block-visible"),$("#secret").focus()):T($("#keyform"),"block-visible","block-hidden")});$("#secret").on("keyup",function(){var a=$("#secret").val().length;16<=a&&32>=a?($("#key-length").css("color","green"),$("#key-length").html("Valid key")):($("#key-length").css("color","red"),$("#key-length").html(a+" characters"))});$(window).on("unload",function(){return confirm("Are you sure you want to logout?")});$(window).focus(function(){y=!0;z=0;Tinycon.setBubble(z);m&&S()}).blur(function(){y=!1});$(window).on("mouseenter, mousemove, mouseover, scroll, resize, keypress, click",
function(){m&&S()})})})();
