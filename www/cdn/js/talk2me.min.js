function random(a,b){return Math.round(Math.random()*(b-a)+a)}Date.prototype.today=function(){return this.getFullYear()+"-"+(10>this.getMonth()+1?"0":"")+(this.getMonth()+1)+"-"+(10>this.getDate()?"0":"")+this.getDate()};Date.prototype.timeNow=function(){return(10>this.getHours()?"0":"")+this.getHours()+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+":"+(10>this.getSeconds()?"0":"")+this.getSeconds()};function getTimestamp(){var a=new Date;return a.today()+" "+a.timeNow()}
function sendMessage(a){void 0===a||1>a.length||(a="<strong>@"+username+"</strong> "+a+' <span class="timestamp">'+getTimestamp()+"</span>",a=strip_tags(a,"<strong><em><table><thead><tbody><tr><th><td><img><br><br/><a><p><div><ul><li><ol><span><hr><hr/><dd><dl><dt>"),conn.send(JSON.stringify({a:"message",msg:a})),appendMessage(a),$("html, body").animate({scrollTop:$(document).height()-$(window).height()}))}
function removeErrorMessages(){var a=$("#error");0<a.size()&&a.each(function(a,c){$(c).remove()})}
function handleMessage(a){isLoggedIn&&(jsonObj=JSON.parse(a),"message"===jsonObj.a?((new Audio("cdn/sounds/notification.ogg")).play(),appendMessage(jsonObj.msg),!windowFocused&&"message"===jsonObj.t&&Tinycon.setBubble(++messageCount)):"login"===jsonObj.a&&(jsonObj.isLoggedIn?(removeErrorMessages(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Username already taken")):
($form='<form role="form"><input name="message" id="message" type="text" class="form-control" placeholder="@'+username+" #"+room+' [enter]" /></form>',$form+='<div class="btn-group btn-status"><button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown"><span id="current-status">Free</span> <span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li><a class="cursor chg-status">Free</a></li><li><a class="cursor chg-status">Away</a></li><li><a class="cursor chg-status">Busy</a></li><li><a class="cursor chg-status">DND!</a></li></ul></div>',
$form+='<button class="logout btn btn-primary btn-sm btn-tooltip" title="Who is online?" id="who"><span class="glyphicon glyphicon-user"></span></button>',$form+='<button class="logout btn btn-danger btn-sm btn-tooltip" id="logout" title="Logout of room"><span class="glyphicon glyphicon-log-out"></span></button>',$("#login-form").replaceWith($form),$("#message").focus(),$("#message").keypress(function(a){if(13==a.which)return a.preventDefault(),sendMessage($("#message").val()),$("#message").val(""),
$("#message").focus(),!1}),applyLogoutEvent(),applyWhoEvent(),applyChangeStatusEvent(),$(".btn-tooltip").tooltip())))}function appendMessage(a){$(".messages").append('<div class="well well-sm">'+a+"</div>")}
function login(){room=$("#room").val();username=$("#username").val();if(void 0!==username&&2<username.length&&9>username.length)isLoggedIn=!0,void 0!==room&&1<room.length||(room="public"),window.location.hash=room+"@"+username,startConnection(room,username);else return removeErrorMessages(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Please enter a username between 3-8 characters!"),
!1}function applyLogoutEvent(){$("#logout").on("click",function(){logout()})}function logout(){isLoggedIn=!1;conn.send(JSON.stringify({a:"logout"}));window.location.href=window.location.protocol+"//"+window.location.hostname+window.location.pathname}function applyChangeStatusEvent(){$(".chg-status").on("click",function(){var a=$(this).text();$("#current-status").text(a);var b={a:"statusChange",status:a};console.log("Sending status change: "+a);conn.send(JSON.stringify(b))})}
function applyWhoEvent(){$("#who").on("click",function(){who()})}function who(){conn.send(JSON.stringify({a:"who"}));$("#message").focus()}function strip_tags(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return a.replace(/<\!--[\s\S]*?--\>|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(a,d){return-1<b.indexOf("<"+d.toLowerCase()+">")?a:""})}function loginToRoom(a,b){conn.send(JSON.stringify({a:"login",room:a,username:b}))}connected=!1;
function startConnection(a,b){connected?loginToRoom(a,b):(conn=new WebSocket(webSocketUrl),conn.onopen=function(){connected=!0;loginToRoom(a,b)},conn.onclose=function(){connected=isLoggedIn=!1;$("#message").remove();$("footer").html('<div id="login-form"><\!--add form on reconnect--\></div>');appendMessage('<span class="connection-lost"><strong style="color:red;">Connection lost.</strong> <strong>Refresh to reconnect.</strong> If this persists please contact your system administrator.</span>');connected||
reConnect()},conn.onmessage=function(a){isLoggedIn&&handleMessage(a.data)})}function reConnect(){conn=new WebSocket(webSocketUrl);conn.onopen=function(){connected=!0};connected?(1>$("#room").size()&&$("body").append('<input id="room" type="hidden" />'),1>$("#username").size()&&$("body").append('<input id="username" type="hidden" />'),init()):setTimeout("reConnect()",2E3)}
function init(){var a=window.location.hash;username=room="";a.match(/#/)&&a.match(/@/)&&(room=a.replace(/^#(.*)@(.*)$/,"$1"),$("#room").val(room),username=a.replace(/^#(.*)@(.*)$/,"$2"),$("#username").val(username),login())}windowFocused=!0;messageCount=0;$(window).focus(function(){windowFocused=!0;messageCount=0;Tinycon.setBubble(messageCount)}).blur(function(){windowFocused=!1});
$(document).ready(function(){isLoggedIn=!1;init();$("#room").focus();$("#room, #username").keypress(function(a){if(13==a.which)return a.preventDefault(),login(),!1});applyLogoutEvent();$(window).on("unload",function(){return confirm("Are you sure you want to logout?")})});
