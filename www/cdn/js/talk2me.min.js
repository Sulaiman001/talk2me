(function(){function R(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})}function t(){var a=new Date;return a.today()+" "+a.timeNow()}function u(){$("html, body").animate({scrollTop:0})}function q(){var a=$("#error");0<a.size()&&a.each(function(a,c){$(c).remove()})}function D(a,b){var c="",c="Free"===b?"@"+a:"@"+a+'.<span class="user-status">'+b+"</span>";0<$(".room-user[data-username='"+a+"']").size()&&(c='<span class="room-user" data-username="'+
a+'">'+c+"</span>",E(a),$("#users-online").prepend(c))}function S(a){1>$(".room-user[data-username='"+a+"']").size()&&(a='<span class="room-user" data-username="'+a+'">@'+a+"</span>",$("#users-online").prepend(a))}function E(a){a=$(".room-user[data-username='"+a+"']");0<a.size()&&a.remove()}function T(a){for(var b in a)1>$(".room-user[data-username='"+b+"']").size()&&$("#users-online").append('<span class="room-user" data-username="'+b+'">'+a[b]+"</span>")}function U(a){if(k)if(a=JSON.parse(a),"message"===
a.a&&"typing"===a.t)1>$(".from-"+a.from).size()&&$.jGrowl(a.msg,{life:3500,group:"from-"+a.from});else if("message"===a.a&&"status-message"===a.t)"disconnect"===a.statusType?E(a.username):"join"===a.statusType?S(a.username):"statusChange"===a.statusType&&D(a.username,a.currentStatus),$.jGrowl(a.msg,{life:1500,group:"from-status-"+a.from});else if("message"===a.a&&"who"===a.t)T(a.users);else if("message"===a.a&&"message"===a.t){0<$(".from-"+a.from).size()&&(v=parseInt((new Date).getTime())-2E3,$(".from-"+
a.from).remove());var b=new Audio("cdn/sounds/"+notifMessage);b.volume=.5;b.play();g&&(a.msg=w(a.msg));a.msg&&r(a.msg,a.encrypted);x||"message"!==a.t||Tinycon.setBubble(++y)}else"showMoreMessages"===a.a?V(a):"login"===a.a&&(a.isLoggedIn?(q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Username already taken")):(b=
$("#message-form").html(),b=Handlebars.compile(b)({room:e,username:d}),$("#login-form").replaceWith(b),h&&($(".messages").before('<div class="more-messages-alert container">Messages will persist in this room.</div>'),$.each(a.messages,function(a,b){g&&(b.message=w(b.message));b.message&&$(".messages").append('<div class="well well-sm message">'+Wwiki.render(b.message)+"</div>")}),s=b=$(a.messages).size(),0<b&&b===a.moreMessagesLimit&&($(".messages").append('<div class="more-messages"><button type="button" class="btn btn-default" id="show-more-messages">More</button>'),
F())),$("#message").focus(),$("#message").keypress(function(a){if(13==a.which)return a.preventDefault(),G(),!1;a=parseInt((new Date).getTime());a-2E3>v&&(f.send(JSON.stringify({a:"typing"})),v=a)}),$("#send-message").on("click",function(){G()}),H(),W(),X(),Y(),$(".btn-tooltip").tooltip()))}function G(){var a=$("#message").val();if(!(void 0===a||1>a.length))if(a.match(/^\s*(\/logout|\/exit|\/quit|\/q)\s*$/))I();else if(a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}!?\s*$/)){var b=a.replace(/\/room\s*([0-9a-zA-Z_\-\.]{1,16})!?\s*/,
"$1");a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}!\s*$/)?window.location.hash="#"+b+"@"+d+"!":window.location.hash="#"+b+"@"+d;location.reload()}else if(a.match(/^\s*(\/clear|\/refresh)\s*$/))z();else{b=a='<span class="room-user-message">@'+d+"</span> "+R(a)+' <span class="timestamp">'+t()+"</span>";if(g)try{a=J(asmCrypto.AES_CBC.encrypt(a,l))}catch(c){console.log("Could not encrypt message."),a=!1}a?(f.send(JSON.stringify({a:"message",msg:a,persistent:h,encrypted:g})),r(b,g)):$.jGrowl("Message not sent - could not encrypt!",
{life:8E3,group:"error-encryption"});u()}$("#message").val("");$("#message").focus()}function r(a,b){console.log("encrypted: "+b);var c="";b&&(c=$(a).find(".room-user-message").after('<span class="glyphicon glyphicon glyphicon-lock"></span>').html());$(".messages").prepend('<div class="well well-sm message">'+Wwiki.render(c)+"</div>")}function A(){e=$("#room").val().trim();d=$("#username").val().trim();if(void 0!==d&&d.match(/^[0-9a-zA-Z_\-\.]{1,16}$/)){k=!0;if(void 0!==e&&1<e.length){if(!e.match(/^[0-9a-zA-Z_\-\.]{1,16}$/))return q(),
$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Rooms must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}else e="public";if($("#usekey").is(":checked")){if(g=!0,l=$("#secret").val(),32!==l.length)return q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),
$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Secret key for client-side encryption must be 32 characters."),!1}else g=!1,l="";$("#persistent").is(":checked")?(h=!0,window.location.hash=e+"@"+d+"!"):window.location.hash=e+"@"+d;$(".header").hide();Z(e,d)}else return $(".header").show(),q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button",
"data-dismiss":"alert"}).after("Usernames must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}function H(){$("#logout").on("click",function(){I()})}function I(){g=k=!1;l="";f.send(JSON.stringify({a:"logout"}));window.location.href=window.location.protocol+"//"+window.location.hostname+window.location.pathname}function Y(){$(".chg-status").on("click",function(){var a=$(this).text();B(a);$("#message").focus();u()})}function B(a){D(d,a);$("#current-status").text(a);f.send(JSON.stringify({a:"statusChange",
status:a}))}function W(){$("#who").on("click",function(){K()})}function X(){$("#clear-messages").on("click",function(){z()})}function z(){var a=$(".message");0<a.size()&&(a.each(function(a,c){$(c).remove()}),K())}function K(){f.send(JSON.stringify({a:"who"}));$("#message").focus();u()}function L(a,b){try{f.send(JSON.stringify({a:"login",room:a,username:b,persistent:h,encrypted:g}))}catch(c){}}function Z(a,b){n?L(a,b):(f=new WebSocket(webSocketUrl),f.onopen=function(c){p&&z();n=!0;p=!1;L(a,b)},f.onclose=
function(a){n=k=!1;$("#message").remove();if(!p){$(".main-control").html('<div id="login-form">\x3c!--add form on reconnect--\x3e</div>');a=$("#connection-lost-msg").html();a=Handlebars.compile(a);var b={timestamp:t()};a=a(b);r(a);C()}},f.onerror=function(a){n=k=!1;$("#message").remove();if(!p){$(".main-control").html('<div id="login-form">\x3c!--add form on reconnect--\x3e</div>');a=$("#connection-lost-msg").html();a=Handlebars.compile(a);var b={timestamp:t()};a=a(b);r(a);C()}},f.onmessage=function(a){k&&
U(a.data)})}function C(){p=!0;n||(1>$("#room").size()&&$("body").append('<input id="room" type="hidden" />'),1>$("#username").size()&&$("body").append('<input id="username" type="hidden" />'),M(),setTimeout(C,2E3),$(".more-messages").remove(),$(".messages").children().remove())}function N(){var a=moment().format("X")-O;!m&&a>idleInSeconds&&"Free"===$("#current-status").text()&&(B("Idle"),m=!0);setTimeout(N,5E3)}function P(){m&&(m=!1,O=moment().format("X"),B("Free"))}function M(){N();d=e="";var a=
window.location.hash;a.match(/#/)&&a.match(/@/)&&(a.match(/!/)?($("#persistent").prop("checked",!0),e=a.replace(/^#(.*)@.*/,"$1"),$("#room").val(e),d=a.replace(/^#.*@(.*)!$/,"$1")):(h=!1,e=a.replace(/^#(.*)@.*/,"$1"),$("#room").val(e),d=a.replace(/^#.*@(.*)$/,"$1")),$("#username").val(d),A())}function Q(a,b,c){0<a.size()&&(a.hasClass(b)&&a.removeClass(b),a.hasClass(c)||a.addClass(c))}function J(a){return String.fromCharCode.apply(null,new Uint16Array(a))}function w(a){try{return J(asmCrypto.AES_CBC.decrypt(a,
l))}catch(b){return console.log("Could not decrypt message."),!1}}function V(a){if(h){$.each(a.messages,function(a,b){g&&(b.message=w(b.message));$(".messages").append('<div class="well well-sm message">'+Wwiki.render(b.message)+"</div>")});var b=$(a.messages).size();s+=b;0<b&&b===a.moreMessagesLimit&&($(".messages").append('<div class="more-messages"><button type="button" class="btn btn-default" id="show-more-messages">More</button>'),F())}}function F(){$("#show-more-messages").on("click",function(){$(".more-messages").remove();
f.send(JSON.stringify({a:"moreMessages",persistent:h,offset:s,encrypted:g}))})}var k=!1,v=parseInt((new Date).getTime())-2E3,g=!1,h=!1,l="",n=!1,p=!1,m=!1,O=moment().format("X"),e="",d="",x=!0,y=0,f=null,s=0;Date.prototype.today=function(){return this.getFullYear()+"-"+(10>this.getMonth()+1?"0":"")+(this.getMonth()+1)+"-"+(10>this.getDate()?"0":"")+this.getDate()};Date.prototype.timeNow=function(){return(10>this.getHours()?"0":"")+this.getHours()+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+
":"+(10>this.getSeconds()?"0":"")+this.getSeconds()};String.prototype.trim=function(){return this.replace(/^\s +|\s +$/g,"")};String.prototype.ltrim=function(){return this.replace(/^\s +/,"")};String.prototype.rtrim=function(){return this.replace(/\s +$/,"")};$(document).ready(function(){M();allowPersistentRooms||$(".persistent-wrapper").remove();$("pre").livequery(function(){$("pre").each(function(a,b){hljs.highlightBlock(b)})});$(".btn-tooltip").tooltip();$("#room").focus();$("#room, #username").keypress(function(a){if(13==
a.which)return a.preventDefault(),A(),!1});$("#login-button").on("click",function(){A();return!1});H();$("#usekey").on("click",function(){$("#usekey").is(":checked")?(Q($("#keyform"),"block-hidden","block-visible"),$("#secret").focus()):Q($("#keyform"),"block-visible","block-hidden")});$("#secret").on("keyup",function(){var a=$("#secret").val().length;32===a?($("#key-length").css("color","green"),$("#key-length").html("Valid key")):($("#key-length").css("color","red"),$("#key-length").html(a+" characters of 32"))});
$(window).on("unload",function(){return confirm("Are you sure you want to logout?")});$(window).focus(function(){x=!0;y=0;Tinycon.setBubble(y);m&&P()}).blur(function(){x=!1});$(window).on("mouseenter, mousemove, mouseover, scroll, resize, keypress, click",function(){m&&P()})})})();
