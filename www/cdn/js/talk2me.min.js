(function(){function p(){var a=new Date;return a.today()+" "+a.timeNow()}function q(){$("html, body").animate({scrollTop:0})}function m(){var a=$("#error");0<a.size()&&a.each(function(a,b){$(b).remove()})}function z(a,c){var b="",b="Free"===c?"@"+a:"@"+a+'.<span class="user-status">'+c+"</span>";0<$(".room-user[data-username='"+a+"']").size()&&(b='<span class="room-user" data-username="'+a+'">'+b+"</span>",A(a),$("#users-online").prepend(b))}function A(a){a=$(".room-user[data-username='"+a+"']");
0<a.size()&&a.remove()}function n(a){$(".messages").prepend('<div class="well well-sm message">'+Wwiki.render(a)+"</div>")}function r(){d=$("#room").val().trim();c=$("#username").val().trim();if(void 0!==c&&c.match(/^[0-9a-zA-Z_\-\.]{1,16}$/)){h=!0;if(void 0!==d&&1<d.length){if(!d.match(/^[0-9a-zA-Z_\-\.]{1,16}$/))return m(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button",
"data-dismiss":"alert"}).after("Rooms must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}else d="public";if($("#usekey").is(":checked")){if(j=!0,i=$("#secret").val(),32!==i.length)return m(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Secret key for client-side encryption must be 32 characters."),!1}else j=!1,i=
"";window.location.hash=d+"@"+c;$(".header").hide();var a=d,f=c;k?B(a,f):(e=new WebSocket(webSocketUrl),e.onopen=function(){l&&s();k=!0;l=!1;B(a,f)},e.onclose=function(){k=h=!1;$("#message").remove();if(!l){$(".main-control").html('<div id="login-form"><\!--add form on reconnect--\></div>');var b=$("#connection-lost-msg").html(),b=Handlebars.compile(b),a={timestamp:p()},b=b(a);n(b);t()}},e.onerror=function(){k=h=!1;$("#message").remove();if(!l){$(".main-control").html('<div id="login-form"><\!--add form on reconnect--\></div>');
var b=$("#connection-lost-msg").html(),b=Handlebars.compile(b),a={timestamp:p()},b=b(a);n(b);t()}},e.onmessage=function(b){if(h&&h)if(b=JSON.parse(b.data),"message"===b.a&&"typing"===b.t)1>$(".from-"+b.from).size()&&$.jGrowl(b.msg,{life:3500,group:"from-"+b.from});else if("message"===b.a&&"status-message"===b.t){if("disconnect"===b.statusType)A(b.username);else if("join"===b.statusType){var a=b.username;1>$(".room-user[data-username='"+a+"']").size()&&$("#users-online").prepend('<span class="room-user" data-username="'+
a+'">@'+a+"</span>")}else"statusChange"===b.statusType&&z(b.username,b.currentStatus);$.jGrowl(b.msg,{life:1500,group:"from-status-"+b.from})}else if("message"===b.a&&"who"===b.t)for(a in b=b.users,b)1>$(".room-user[data-username='"+a+"']").size()&&$("#users-online").append('<span class="room-user" data-username="'+a+'">'+b[a]+"</span>");else if("message"===b.a&&"message"===b.t){0<$(".from-"+b.from).size()&&(u=parseInt((new Date).getTime())-v,$(".from-"+b.from).remove());a=new Audio("cdn/sounds/"+
notifMessage);a.volume=0.5;a.play();if(j){var f;a:{try{f=C(asmCrypto.AES_CBC.decrypt(b.msg,i));break a}catch(g){console.log("Could not decrypt message.")}f=void 0}b.msg=f}n(b.msg);!w&&"message"===b.t&&Tinycon.setBubble(++x)}else"login"===b.a&&(b.isLoggedIn?(m(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Username already taken")):
(b=$("#message-form").html(),b=Handlebars.compile(b)({room:d,username:c}),$("#login-form").replaceWith(b),$("#message").focus(),$("#message").keypress(function(a){if(13==a.which){a.preventDefault();a=$("#message").val();if(!(void 0===a||1>a.length))if(a.match(/^\s*(\/logout|\/exit|\/quit|\/q)\s*$/))D();else if(a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}\s*$/))a=a.replace(/\/room\s*([0-9a-zA-Z_\-\.]{1,16})/,"$1"),window.location.hash="#"+a+"@"+c,location.reload();else if(a.match(/^\s*(\/clear|\/refresh)\s*$/))s();
else{var a='<span class="room-user-message">@'+c+"</span> "+a+' <span class="timestamp">'+p()+"</span>",b="<strong><em><table><thead><tbody><tr><th><td><img><br><br/><a><p><div><ul><li><ol><span><hr><hr/><dd><dl><dt>",b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join(""),f=a=a.replace(/<\!--[\s\S]*?--\>|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(a,c){return-1<b.indexOf("<"+c.toLowerCase()+">")?a:""});if(j)a:{try{a=C(asmCrypto.AES_CBC.encrypt(a,
i));break a}catch(d){console.log("Could not encrypt message.")}a=void 0}e.send(JSON.stringify({a:"message",msg:a}));n(f);q()}$("#message").val("");$("#message").focus();return!1}a=parseInt((new Date).getTime());a-v>u&&(e.send(JSON.stringify({a:"typing"})),u=a)}),E(),$("#who").on("click",function(){F()}),$("#clear-messages").on("click",function(){s()}),$(".chg-status").on("click",function(){var a=$(this).text();y(a);$("#message").focus();q()}),$(".btn-tooltip").tooltip()))})}else return $(".header").show(),
m(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Usernames must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}function E(){$("#logout").on("click",function(){D()})}function D(){j=h=!1;i="";e.send(JSON.stringify({a:"logout"}));window.location.href=window.location.protocol+"//"+window.location.hostname+window.location.pathname}
function y(a){z(c,a);$("#current-status").text(a);e.send(JSON.stringify({a:"statusChange",status:a}))}function s(){var a=$(".message");0<a.size()&&(a.each(function(a,b){$(b).remove()}),F())}function F(){e.send(JSON.stringify({a:"who"}));$("#message").focus();q()}function B(a,c){try{e.send(JSON.stringify({a:"login",room:a,username:c}))}catch(b){}}function t(){l=!0;k||(1>$("#room").size()&&$("body").append('<input id="room" type="hidden" />'),1>$("#username").size()&&$("body").append('<input id="username" type="hidden" />'),
G(),setTimeout(t,2E3))}function H(){var a=moment().format("X")-I;!g&&(a>idleInSeconds&&"Free"===$("#current-status").text())&&(y("Idle"),g=!0);setTimeout(H,5E3)}function J(){g&&(g=!1,I=moment().format("X"),y("Free"))}function G(){H();c=d="";var a=window.location.hash;a.match(/#/)&&a.match(/@/)&&(d=a.replace(/^#(.*)@(.*)$/,"$1"),$("#room").val(d),c=a.replace(/^#(.*)@(.*)$/,"$2"),$("#username").val(c),r())}function K(a,c,b){0<a.size()&&(a.hasClass(c)&&a.removeClass(c),a.hasClass(b)||a.addClass(b))}
function C(a){return String.fromCharCode.apply(null,new Uint16Array(a))}var h=!1,v=2E3,u=parseInt((new Date).getTime())-v,j=!1,i="",k=!1,l=!1,g=!1,I=moment().format("X"),d="",c="",w=!0,x=0,e=null;Date.prototype.today=function(){return this.getFullYear()+"-"+(10>this.getMonth()+1?"0":"")+(this.getMonth()+1)+"-"+(10>this.getDate()?"0":"")+this.getDate()};Date.prototype.timeNow=function(){return(10>this.getHours()?"0":"")+this.getHours()+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+":"+(10>this.getSeconds()?
"0":"")+this.getSeconds()};String.prototype.trim=function(){return this.replace(/^\s +|\s +$/g,"")};String.prototype.ltrim=function(){return this.replace(/^\s +/,"")};String.prototype.rtrim=function(){return this.replace(/\s +$/,"")};$(document).ready(function(){G();$(".btn-tooltip").tooltip();$("#room").focus();$("#room, #username").keypress(function(a){if(13==a.which)return a.preventDefault(),r(),!1});$("#login-button").on("click",function(){r();return!1});E();$("#usekey").on("click",function(){$("#usekey").is(":checked")?
(K($("#keyform"),"block-hidden","block-visible"),$("#secret").focus()):K($("#keyform"),"block-visible","block-hidden")});$("#secret").on("keyup",function(){var a=$("#secret").val().length;32===a?($("#key-length").css("color","green"),$("#key-length").html("Valid key")):($("#key-length").css("color","red"),$("#key-length").html(a+" characters of 32"))});$(window).on("unload",function(){return confirm("Are you sure you want to logout?")});$(window).focus(function(){w=!0;x=0;Tinycon.setBubble(x);g&&
J()}).blur(function(){w=!1});$(window).on("mouseenter, mousemove, mouseover, scroll, resize, keypress, click",function(){g&&J()})})})();
