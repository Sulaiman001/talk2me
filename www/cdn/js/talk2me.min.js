(function(){function V(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})}function t(){var a=new Date;return a.today()+" "+a.timeNow()}function u(){$("html, body").animate({scrollTop:0})}function q(){var a=$("#error");0<a.size()&&a.each(function(a,c){$(c).remove()})}function G(a,b,c){var v="";c&&(v=H()+" ");c="";c="Free"===b?v+"@"+a:v+"@"+a+'.<span class="user-status">'+b+"</span>";0<$(".room-user[data-username='"+a+"']").size()&&
(b='<span class="room-user" data-username="'+a+'">'+c+"</span>",I(a),$("#users-online").prepend(b))}function W(a,b){var c="";b&&(c=H()+" ");1>$(".room-user[data-username='"+a+"']").size()&&(c='<span class="room-user" data-username="'+a+'">'+c+"@"+a+"</span>",$("#users-online").prepend(c))}function I(a,b){var c=$(".room-user[data-username='"+a+"']");0<c.size()&&c.remove()}function X(a){for(var b in a)1>$(".room-user[data-username='"+b+"']").size()&&$("#users-online").append('<span class="room-user" data-username="'+
b+'">'+a[b]+"</span>")}function w(a,b){return!a||b&&a?!0:!1}function Y(a){if(k)if(a=JSON.parse(a),"message"===a.a&&"typing"===a.t)w(a.encrypted,d)&&1>$(".from-"+a.from).size()&&$.jGrowl(a.msg,{life:3500,group:"from-"+a.from});else if("message"===a.a&&"status-message"===a.t)w(a.encrypted,d)&&("disconnect"===a.statusType?I(a.username,a.encrypted):"join"===a.statusType?W(a.username,a.encrypted):"statusChange"===a.statusType&&G(a.username,a.currentStatus,a.encrypted),$.jGrowl(a.msg,{life:1500,group:"from-status-"+
a.from}));else if("message"===a.a&&"who"===a.t)X(a.users);else if("message"===a.a&&"message"===a.t){if(a.msg&&(d&&a.encrypted&&(a.msg=x(a.msg)),w(a.encrypted,d))){0<$(".from-"+a.from).size()&&(y=parseInt((new Date).getTime())-2E3,$(".from-"+a.from).remove());var b=new Audio("cdn/sounds/"+notifMessage);b.volume=.5;b.play();r(a.msg,a.encrypted);z||"message"!==a.t||Tinycon.setBubble(++A)}}else"showMoreMessages"===a.a?Z(a):"login"===a.a&&(a.isLoggedIn?(q(),$("#login-form").prepend('<div id="error"></div>'),
$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Username already taken")):(b=$("#message-form").html(),b=Handlebars.compile(b)({room:f,username:e}),$("#login-form").replaceWith(b),h&&($(".messages").before('<div class="more-messages-alert container">Persistent messages enabled</div>'),$.each(a.messages,function(a,b){b.item.encrypted&&(b.item.message=B()+" "+x(b.item.message));
b.item.message&&$(".messages").append('<div class="well well-sm message">'+Wwiki.render(b.item.message)+"</div>")}),s=b=$(a.messages).size(),0<b&&b===a.moreMessagesLimit&&($(".messages").append('<div class="more-messages"><button type="button" class="btn btn-default" id="show-more-messages">More</button>'),J())),$("#message").focus(),$("#message").keypress(function(a){if(13==a.which)return a.preventDefault(),K(),!1;a=parseInt((new Date).getTime());a-2E3>y&&(g.send(JSON.stringify({a:"typing",encrypted:d})),
y=a)}),$("#send-message").on("click",function(){K()}),L(),aa(),ba(),ca(),$(".btn-tooltip").tooltip()))}function K(){var a=$("#message").val();if(!(void 0===a||1>a.length))if(a.match(/^\s*(\/logout|\/exit|\/quit|\/q)\s*$/))M();else if(a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}!?\s*$/)){var b=a.replace(/\/room\s*([0-9a-zA-Z_\-\.]{1,16})!?\s*/,"$1");a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}!\s*$/)?window.location.hash="#"+b+"@"+e+"!":window.location.hash="#"+b+"@"+e;location.reload()}else if(a.match(/^\s*(\/clear|\/refresh)\s*$/))C();
else{b=a='<span class="room-user-message">@'+e+"</span> "+V(a)+' <span class="timestamp">'+t()+"</span>";if(d)try{a=N(asmCrypto.AES_CBC.encrypt(a,l))}catch(c){console.log("Could not encrypt message."),a=!1}a?(g.send(JSON.stringify({a:"message",msg:a,persistent:h,encrypted:d})),r(b,d)):$.jGrowl("Message not sent - could not encrypt!",{life:8E3,group:"error-encryption"});u()}$("#message").val("");$("#message").focus()}function B(){return'<span class="glyphicon glyphicon-lock btn-tooltip" title="This message is encrypted."></span>'}
function H(){return'<span class="glyphicon glyphicon-lock btn-tooltip" title="This users messages are encrypted."></span>'}function r(a,b){b&&(a=B()+" "+a);$(".messages").prepend('<div class="well well-sm message">'+Wwiki.render(a)+"</div>")}function D(){f=$("#room").val().trim();e=$("#username").val().trim();if(void 0!==e&&e.match(/^[0-9a-zA-Z_\-\.]{1,16}$/)){k=!0;if(void 0!==f&&1<f.length){if(!f.match(/^[0-9a-zA-Z_\-\.]{1,16}$/))return q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),
$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Rooms must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}else f="public";if($("#usekey").is(":checked")){if(d=!0,l=$("#secret").val(),32!==l.length)return q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Secret key for client-side encryption must be 32 characters."),
!1}else d=!1,l="";$("#persistent").is(":checked")?(h=!0,window.location.hash=f+"@"+e+"!"):window.location.hash=f+"@"+e;$(".header").hide();da(f,e)}else return $(".header").show(),q(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Usernames must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}function L(){$("#logout").on("click",
function(){M()})}function M(){d=k=!1;l="";g.send(JSON.stringify({a:"logout",encrypted:d}));window.location.href=window.location.protocol+"//"+window.location.hostname+window.location.pathname}function ca(){$(".chg-status").on("click",function(){var a=$(this).text();E(a);$("#message").focus();u()})}function E(a){G(e,a,d);$("#current-status").text(a);g.send(JSON.stringify({a:"statusChange",status:a,encrypted:d}))}function aa(){$("#who").on("click",function(){O()})}function ba(){$("#clear-messages").on("click",
function(){C()})}function C(){var a=$(".message");0<a.size()&&(a.each(function(a,c){$(c).remove()}),O())}function O(){g.send(JSON.stringify({a:"who",encrypted:d}));$("#message").focus();u()}function P(a,b){try{g.send(JSON.stringify({a:"login",room:a,username:b,persistent:h,encrypted:d}))}catch(c){}}function da(a,b){n?P(a,b):(g=new WebSocket(webSocketUrl),g.onopen=function(c){p&&C();n=!0;p=!1;P(a,b)},g.onclose=function(a){n=k=!1;$("#message").remove();if(!p){$(".main-control").html('<div id="login-form">\x3c!--add form on reconnect--\x3e</div>');
a=$("#connection-lost-msg").html();a=Handlebars.compile(a);var b={timestamp:t()};a=a(b);r(a);F()}},g.onerror=function(a){n=k=!1;$("#message").remove();if(!p){$(".main-control").html('<div id="login-form">\x3c!--add form on reconnect--\x3e</div>');a=$("#connection-lost-msg").html();a=Handlebars.compile(a);var b={timestamp:t()};a=a(b);r(a);F()}},g.onmessage=function(a){k&&Y(a.data)})}function F(){p=!0;n||(1>$("#room").size()&&$("body").append('<input id="room" type="hidden" />'),1>$("#username").size()&&
$("body").append('<input id="username" type="hidden" />'),Q(),setTimeout(F,2E3),$(".more-messages").remove(),$(".messages").children().remove())}function R(){var a=moment().format("X")-S;!m&&a>idleInSeconds&&"Free"===$("#current-status").text()&&(E("Idle"),m=!0);setTimeout(R,5E3)}function T(){m&&(m=!1,S=moment().format("X"),E("Free"))}function Q(){R();e=f="";var a=window.location.hash;a.match(/#/)&&a.match(/@/)&&(a.match(/!/)?($("#persistent").prop("checked",!0),f=a.replace(/^#(.*)@.*/,"$1"),$("#room").val(f),
e=a.replace(/^#.*@(.*)!$/,"$1")):(h=!1,f=a.replace(/^#(.*)@.*/,"$1"),$("#room").val(f),e=a.replace(/^#.*@(.*)$/,"$1")),$("#username").val(e),D())}function U(a,b,c){0<a.size()&&(a.hasClass(b)&&a.removeClass(b),a.hasClass(c)||a.addClass(c))}function N(a){return String.fromCharCode.apply(null,new Uint16Array(a))}function x(a){try{return N(asmCrypto.AES_CBC.decrypt(a,l))}catch(b){return console.log("Could not decrypt message."),!1}}function Z(a){if(h){$.each(a.messages,function(a,b){b.item.encrypted&&
(b.item.message=B()+" "+x(b.item.message));$(".messages").append('<div class="well well-sm message">'+Wwiki.render(b.item.message)+"</div>")});var b=$(a.messages).size();s+=b;0<b&&b===a.moreMessagesLimit&&($(".messages").append('<div class="more-messages"><button type="button" class="btn btn-default" id="show-more-messages">More</button>'),J())}}function J(){$("#show-more-messages").on("click",function(){$(".more-messages").remove();g.send(JSON.stringify({a:"moreMessages",persistent:h,offset:s,encrypted:d}))})}
var k=!1,y=parseInt((new Date).getTime())-2E3,d=!1,h=!1,l="",n=!1,p=!1,m=!1,S=moment().format("X"),f="",e="",z=!0,A=0,g=null,s=0;Date.prototype.today=function(){return this.getFullYear()+"-"+(10>this.getMonth()+1?"0":"")+(this.getMonth()+1)+"-"+(10>this.getDate()?"0":"")+this.getDate()};Date.prototype.timeNow=function(){return(10>this.getHours()?"0":"")+this.getHours()+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+":"+(10>this.getSeconds()?"0":"")+this.getSeconds()};String.prototype.trim=function(){return this.replace(/^\s +|\s +$/g,
"")};String.prototype.ltrim=function(){return this.replace(/^\s +/,"")};String.prototype.rtrim=function(){return this.replace(/\s +$/,"")};$(document).ready(function(){Q();allowPersistentRooms||$(".persistent-wrapper").remove();$("pre").livequery(function(){$("pre").each(function(a,b){hljs.highlightBlock(b)})});$(".btn-tooltip").livequery(function(){$(".btn-tooltip").tooltip()});$(".btn-help").livequery(function(){$(".btn-help").popover({html:!0,placement:"auto left"})});$("#room").focus();$("#room, #username").keypress(function(a){if(13==
a.which)return a.preventDefault(),D(),!1});$("#login-button").on("click",function(){D();return!1});L();$("#usekey").on("click",function(){$("#usekey").is(":checked")?(U($("#keyform"),"block-hidden","block-visible"),$("#secret").focus()):U($("#keyform"),"block-visible","block-hidden")});$("#secret").on("keyup",function(){var a=$("#secret").val().length;32===a?($("#key-length").css("color","green"),$("#key-length").html("Valid key")):($("#key-length").css("color","red"),$("#key-length").html(a+" characters of 32"))});
$(window).on("unload",function(){return confirm("Are you sure you want to logout?")});$(window).focus(function(){z=!0;A=0;Tinycon.setBubble(A);m&&T()}).blur(function(){z=!1});$(window).on("mouseenter, mousemove, mouseover, scroll, resize, keypress, click",function(){m&&T()})})})();
