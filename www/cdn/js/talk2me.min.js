function random(a,b){return Math.round(Math.random()*(b-a)+a)}Date.prototype.today=function(){return this.getFullYear()+"-"+(10>this.getMonth()+1?"0":"")+(this.getMonth()+1)+"-"+(10>this.getDate()?"0":"")+this.getDate()};Date.prototype.timeNow=function(){return(10>this.getHours()?"0":"")+this.getHours()+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+":"+(10>this.getSeconds()?"0":"")+this.getSeconds()};String.prototype.trim=function(){return this.replace(/^\s +|\s +$/g,"")};
String.prototype.ltrim=function(){return this.replace(/^\s +/,"")};String.prototype.rtrim=function(){return this.replace(/\s +$/,"")};function getTimestamp(){var a=new Date;return a.today()+" "+a.timeNow()}
function sendMessage(a){if(!(void 0===a||1>a.length))if(a.match(/^\s*(\/logout|\/exit|\/quit|\/q)\s*$/))logout();else if(a.match(/^\s*\/room\s*[0-9a-zA-Z_\-\.]{1,16}\s*$/))a=a.replace(/\/room\s*([0-9a-zA-Z_\-\.]{1,16})/,"$1"),window.location.hash="#"+a+"@"+username,location.reload();else if(a.match(/^\s*(\/clear|\/refresh)\s*$/))clearMessages();else{var a="<strong>@"+username+"</strong> "+a+' <span class="timestamp">'+getTimestamp()+"</span>",b=a=strip_tags(a,"<strong><em><table><thead><tbody><tr><th><td><img><br><br/><a><p><div><ul><li><ol><span><hr><hr/><dd><dl><dt>");
usekey&&(a=encryptMessage(a));conn.send(JSON.stringify({a:"message",msg:a}));appendMessage(b);scrollToTop()}}function scrollToBottom(){$("html, body").animate({scrollTop:$(document).height()-$(window).height()})}function scrollToTop(){$("html, body").animate({scrollTop:0})}function removeErrorMessages(){var a=$("#error");0<a.size()&&a.each(function(a,c){$(c).remove()})}
function updateRoomMember(a,b){var c="",c="Free"===b?"@"+a:"@"+a+'.<span class="user-status">'+b+"</span>";0<$(".room-user[data-username='"+a+"']").size()&&(c='<span class="room-user" data-username="'+a+'">'+c+"</span>",removeRoomMember(a),$("#users-online").prepend(c))}function addRoomMember(a){1>$(".room-user[data-username='"+a+"']").size()&&$("#users-online").prepend('<span class="room-user" data-username="'+a+'">@'+a+"</span>")}
function removeRoomMember(a){a=$(".room-user[data-username='"+a+"']");0<a.size()&&a.remove()}function updateRoomMembers(a){for(var b in a)1>$(".room-user[data-username='"+b+"']").size()&&$("#users-online").append('<span class="room-user" data-username="'+b+'">'+a[b]+"</span>")}threshold=2E3;lastTyping=parseInt((new Date).getTime())-threshold;
function handleMessage(a){isLoggedIn&&(jsonObj=JSON.parse(a),"message"===jsonObj.a&&"typing"===jsonObj.t?1>$(".from-"+jsonObj.from).size()&&$.jGrowl(jsonObj.msg,{life:3500,group:"from-"+jsonObj.from}):"message"===jsonObj.a&&"status-message"===jsonObj.t?("disconnect"===jsonObj.statusType?removeRoomMember(jsonObj.username):"join"===jsonObj.statusType?addRoomMember(jsonObj.username):"statusChange"===jsonObj.statusType&&updateRoomMember(jsonObj.username,jsonObj.currentStatus),$.jGrowl(jsonObj.msg,{life:1500,
group:"from-status-"+jsonObj.from})):"message"===jsonObj.a&&"who"===jsonObj.t?updateRoomMembers(jsonObj.users):"message"===jsonObj.a&&"message"===jsonObj.t?(0<$(".from-"+jsonObj.from).size()&&(lastTyping=parseInt((new Date).getTime())-threshold,$(".from-"+jsonObj.from).remove()),a=new Audio("cdn/sounds/"+notifMessage),a.volume=0.5,a.play(),usekey&&(jsonObj.msg=decryptMessage(jsonObj.msg)),appendMessage(jsonObj.msg),!windowFocused&&"message"===jsonObj.t&&Tinycon.setBubble(++messageCount)):"login"===
jsonObj.a&&(jsonObj.isLoggedIn?(removeErrorMessages(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Username already taken")):(a=$("#message-form").html(),a=Handlebars.compile(a)({room:room,username:username}),$("#login-form").replaceWith(a),$("#message").focus(),$("#message").keypress(function(a){if(13==a.which)return a.preventDefault(),
sendMessage($("#message").val()),$("#message").val(""),$("#message").focus(),!1;a=parseInt((new Date).getTime());a-threshold>lastTyping&&(sendTyping(),lastTyping=a)}),applyLogoutEvent(),applyWhoEvent(),applyClearMessagesEvent(),applyChangeStatusEvent(),$(".btn-tooltip").tooltip())))}function sendTyping(){conn.send(JSON.stringify({a:"typing"}))}function appendMessage(a){$(".messages").prepend('<div class="well well-sm message">'+Wwiki.render(a)+"</div>")}usekey=!1;secret="";
function login(){room=$("#room").val().trim();username=$("#username").val().trim();if(void 0!==username&&username.match(/^[0-9a-zA-Z_\-\.]{1,16}$/)){isLoggedIn=!0;if(void 0!==room&&1<room.length){if(!room.match(/^[0-9a-zA-Z_\-\.]{1,16}$/))return removeErrorMessages(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Rooms must be 1-16 of these characters: 0-9a-zA-Z_-."),
!1}else room="public";if($("#usekey").is(":checked")){if(usekey=!0,secret=$("#secret").val(),32!==secret.length)return removeErrorMessages(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Secret key for client-side encryption must be 32 characters."),!1}else usekey=!1,secret="";window.location.hash=room+"@"+username;
$(".header").hide();startConnection(room,username)}else return $(".header").show(),removeErrorMessages(),$("#login-form").prepend('<div id="error"></div>'),$("#error").addClass("alert alert-warning fade in").append('<button id="close">&times;</button>'),$("#close").addClass("close").attr({type:"button","data-dismiss":"alert"}).after("Usernames must be 1-16 of these characters: 0-9a-zA-Z_-."),!1}function applyLogoutEvent(){$("#logout").on("click",function(){logout()})}
function logout(){usekey=isLoggedIn=!1;secret="";conn.send(JSON.stringify({a:"logout"}));window.location.href=window.location.protocol+"//"+window.location.hostname+window.location.pathname}function applyChangeStatusEvent(){$(".chg-status").on("click",function(){var a=$(this).text();sendChangeStatus(a);$("#message").focus();scrollToTop()})}function sendChangeStatus(a){updateRoomMember(username,a);$("#current-status").text(a);conn.send(JSON.stringify({a:"statusChange",status:a}))}
function getStatus(){return $("#current-status").text()}function applyWhoEvent(){$("#who").on("click",function(){who()})}function applyClearMessagesEvent(){$("#clear-messages").on("click",function(){clearMessages()})}function clearMessages(){var a=$(".message");0<a.size()&&(a.each(function(a,c){$(c).remove()}),who())}function who(){conn.send(JSON.stringify({a:"who"}));$("#message").focus();scrollToTop()}
function strip_tags(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return a.replace(/<\!--[\s\S]*?--\>|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(a,d){return-1<b.indexOf("<"+d.toLowerCase()+">")?a:""})}function loginToRoom(a,b){try{conn.send(JSON.stringify({a:"login",room:a,username:b}))}catch(c){}}connected=!1;
function startConnection(a,b){connected?loginToRoom(a,b):(conn=new WebSocket(webSocketUrl),conn.onopen=function(){connected=!0;reConnecting=!1;loginToRoom(a,b)},conn.onclose=function(){connected=isLoggedIn=!1;$("#message").remove();if(!reConnecting){$(".main-control").html('<div id="login-form"><\!--add form on reconnect--\></div>');var a=$("#connection-lost-msg").html(),a=Handlebars.compile(a),b={timestamp:getTimestamp()},a=a(b);appendMessage(a);reConnect()}},conn.onerror=function(){connected=isLoggedIn=
!1;$("#message").remove();if(!reConnecting){$(".main-control").html('<div id="login-form"><\!--add form on reconnect--\></div>');var a=$("#connection-lost-msg").html(),a=Handlebars.compile(a),b={timestamp:getTimestamp()},a=a(b);appendMessage(a);reConnect()}},conn.onmessage=function(a){isLoggedIn&&handleMessage(a.data)})}reConnecting=!1;
function reConnect(){reConnecting=!0;connected||(1>$("#room").size()&&$("body").append('<input id="room" type="hidden" />'),1>$("#username").size()&&$("body").append('<input id="username" type="hidden" />'),init(),setTimeout("reConnect()",2E3))}idle=!1;lastActive=moment().format("X");function autoSetStatus(){var a=moment().format("X")-lastActive;!idle&&(a>idleInSeconds&&"Free"===getStatus())&&(sendChangeStatus("Idle"),idle=!0);setTimeout("autoSetStatus()",5E3)}
function resetIdleStatus(){idle&&(idle=!1,lastActive=moment().format("X"),sendChangeStatus("Free"))}function init(){autoSetStatus();var a=window.location.hash;username=room="";a.match(/#/)&&a.match(/@/)&&(room=a.replace(/^#(.*)@(.*)$/,"$1"),$("#room").val(room),username=a.replace(/^#(.*)@(.*)$/,"$2"),$("#username").val(username),login())}function switchClass(a,b,c){0<a.size()&&(a.hasClass(b)&&a.removeClass(b),a.hasClass(c)||a.addClass(c))}
function ab2str(a){return String.fromCharCode.apply(null,new Uint16Array(a))}function str2ab(a){for(var b=new ArrayBuffer(2*a.length),c=new Uint16Array(b),d=0,e=a.length;d<e;d++)c[d]=a.charCodeAt(d);return b}function encryptMessage(a){try{return ab2str(asmCrypto.AES_CBC.encrypt(a,secret))}catch(b){console.log("Could not encrypt message.")}}function decryptMessage(a){try{return ab2str(asmCrypto.AES_CBC.decrypt(a,secret))}catch(b){console.log("Could not decrypt message.")}}
$(document).ready(function(){isLoggedIn=!1;init();$(".btn-tooltip").tooltip();$("#room").focus();$("#room, #username").keypress(function(a){if(13==a.which)return a.preventDefault(),login(),!1});$("#login-button").on("click",function(){login();return!1});applyLogoutEvent();$("#usekey").on("click",function(){$("#usekey").is(":checked")?(switchClass($("#keyform"),"block-hidden","block-visible"),$("#secret").focus()):switchClass($("#keyform"),"block-visible","block-hidden")});$("#secret").on("keyup",
function(){var a=$("#secret").val().length;32===a?($("#key-length").css("color","green"),$("#key-length").html("Valid key")):($("#key-length").css("color","red"),$("#key-length").html(a+" characters of 32"))});$(window).on("unload",function(){return confirm("Are you sure you want to logout?")});windowFocused=!0;messageCount=0;$(window).focus(function(){windowFocused=!0;messageCount=0;Tinycon.setBubble(messageCount);idle&&resetIdleStatus()}).blur(function(){windowFocused=!1});$(window).on("mouseenter, mousemove, mouseover, scroll, resize, keypress, click",
function(){idle&&resetIdleStatus()})});
